{{ $position := .position }}

{{ $show_description := .data.show_description }}
{{ $show_image := .data.show_image }}
{{ $page_primary_title := "" }}
{{ $block_class := "" }}

{{ $page := partial "GetPageByUrl" .data.page }}
{{ with $page }}
  {{ $page_primary_title = .Title }}
  {{ if .Params.bodyclass }}
    {{ $block_class = .Params.bodyclass }}
  {{ end }}
{{ end }}
<section class="block-pages {{ $block_class }}">

  {{ if and .title (ne .title $page_primary_title) }}
    <div class="top">
      <h2 id="block-{{ $position }}">{{ partial "PrepareHTML" .title }}</h2>
    </div>
  {{ end }}

  {{ with $page }}

    <div class="page">
      <div>
        <p class="title">
          <a href="{{ .Permalink }}">{{ partial "PrepareHTML" .Title }}</a>
        </p>
        {{ if and .Params.description_short $show_description }}
          <p>{{- partial "PrepareHTML" .Params.description_short -}}</p>
        {{ end }}
      </div>
      {{ if $show_image }}
        <div class="media">
          {{- if .Params.image -}}
            {{- partial "commons/image.html"
                  (dict
                    "image"    .Params.image
                    "alt"      .Title
                    "mobile"   "351x291"
                    "tablet"   "334x167"
                    "desktop"  "634x317"
                  ) -}}
          {{- else -}}
            {{- partial "commons/image-default.html" -}}
          {{- end -}}
        </div>
      {{ end }}
    </div>

  {{ end }}

  <div class="pages">
    {{ range .data.pages }}
      {{ $show_description := .show_description }}
      {{ $show_image := .show_image }}
      {{ $page := partial "GetPageByUrl" .slug }}
      {{ with $page }}
        <div>

          <div class="page{{ if .Params.bodyclass }} page-{{ .Params.bodyclass }}{{ end }}">
            <div>
              <p class="title">
                <a href="{{ .Permalink }}">
                  {{ partial "PrepareHTML" .Title }}
                </a>
              </p>
              {{ if and .Params.description_short $show_description }}
                <p>{{- partial "GetTruncateContent" .Params.description_short -}}</p>
              {{ end }}
            </div>
            {{ if $show_image }}
              <div class="media">
                {{- if .Params.image -}}
                  {{- partial "commons/image.html"
                        (dict
                          "image"    .Params.image
                          "alt"      .Title
                          "mobile"   "351x291"
                          "tablet"   "334x167"
                          "desktop"  "634x317"
                        ) -}}
                {{- else -}}
                  {{- partial "commons/image-default.html" -}}
                {{- end -}}
              </div>
            {{ end }}
          </div>

        </div>
      {{ end }}
    {{ end }}
  </div>
</section>
